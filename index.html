<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI - Platform V7</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        midnight: { 950: '#020617', 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        accent: { blue: '#3b82f6', purple: '#a855f7', pink: '#ec4899' }
                    },
                    animation: { 'pulse-slow': 'pulse 3s infinite' }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL STYLES --- */
        html, body {
            height: 100%; width: 100%; overflow: hidden;
            background: #020617; color: #e2e8f0;
            overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent;
        }
        
        /* --- HEADER & NAV --- */
        .nav-link { @apply flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all cursor-pointer; }
        .nav-link.active { @apply bg-accent-blue/10 text-accent-blue font-medium; }

        /* --- CHARACTER CARDS --- */
        .char-card { @apply relative bg-midnight-800 border border-white/5 rounded-2xl overflow-hidden cursor-pointer transition-all hover:border-accent-blue/50 hover:shadow-lg hover:shadow-accent-blue/10 hover:-translate-y-1; }
        .char-card .avatar { @apply w-full aspect-square object-cover bg-midnight-900; }
        .char-card .info { @apply p-4 bg-gradient-to-t from-midnight-950 via-midnight-900 to-transparent absolute bottom-0 left-0 right-0; }

        /* --- CHAT BUBBLES --- */
        .msg-content { user-select: text; -webkit-user-select: text; }
        .msg-user { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; border-radius: 18px 18px 4px 18px; }
        .msg-user em { color: #fde047 !important; opacity: 0.95; } .msg-user strong { color: #fff !important; }
        .msg-ai { background: #1e293b; border-radius: 18px 18px 18px 4px; }
        .msg-ai em { color: #c084fc !important; } .msg-ai strong { color: #f8fafc !important; }

        /* --- UTILS --- */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .cursor-blink { display: inline-block; width: 6px; height: 16px; background-color: #c084fc; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="flex flex-col h-full">

    <header class="shrink-0 h-16 bg-midnight-900 border-b border-white/5 flex items-center justify-between px-4 z-50 relative">
        <div class="flex items-center gap-4">
            <button class="md:hidden text-gray-400 hover:text-white" onclick="toggleSidebar()"><i class="ph ph-list text-2xl"></i></button>
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Universal AI</h1>
        </div>

        <div class="hidden md:flex flex-1 max-w-xl mx-8 relative">
            <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
            <input type="text" placeholder="Search characters, lore..." class="w-full bg-midnight-950 border border-white/10 rounded-full py-2 pl-10 pr-4 text-sm focus:border-accent-blue/50 outline-none">
        </div>

        <div class="flex items-center gap-2">
            <div class="relative">
                <button onclick="toggleDropdown('add-menu')" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-full transition-colors">
                    <i class="ph ph-plus-circle text-2xl"></i>
                </button>
                <div id="add-menu" class="hidden absolute right-0 top-full mt-2 w-48 bg-midnight-800 border border-white/10 rounded-xl shadow-xl py-2 z-50">
                    <button onclick="openModal('add-char-modal')" class="w-full text-left px-4 py-2.5 hover:bg-white/5 flex items-center gap-3 text-sm"><i class="ph ph-user-plus text-accent-blue"></i> New Character</button>
                    <button class="w-full text-left px-4 py-2.5 hover:bg-white/5 flex items-center gap-3 text-sm opacity-50 cursor-not-allowed"><i class="ph ph-book-bookmark text-accent-purple"></i> New Lorebook (Soon)</button>
                </div>
            </div>
            <button onclick="openModal('settings-modal')" class="p-1 rounded-full border-2 border-transparent hover:border-accent-blue/50 transition-all">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-accent-blue to-accent-purple flex items-center justify-center"><i class="ph ph-user text-white"></i></div>
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        
        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-midnight-900 border-r border-white/5 transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-40 flex flex-col z-50 pt-16 md:pt-0">
            <div class="p-4 space-y-2 flex-1">
                <div class="nav-link active" onclick="switchView('chars-view')"><i class="ph ph-users text-xl"></i> My Characters</div>
                <div class="nav-link opacity-50 cursor-not-allowed"><i class="ph ph-books text-xl"></i> Lorebooks (Soon)</div>
            </div>
            <div class="p-4 border-t border-white/5">
                <div class="nav-link" onclick="openModal('settings-modal')"><i class="ph ph-gear text-xl"></i> Settings</div>
            </div>
        </aside>
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-30 hidden md:hidden backdrop-blur-sm"></div>

        <main class="flex-1 relative overflow-hidden bg-midnight-950">
            
            <div id="chars-view" class="absolute inset-0 overflow-y-auto p-4 md:p-8 scroll-smooth">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i class="ph ph-users-three text-accent-blue"></i> My Characters</h2>
                    <div id="chars-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        </div>
                    <div id="no-chars-msg" class="hidden flex flex-col items-center justify-center py-20 text-center opacity-60">
                        <i class="ph ph-user-plus text-6xl mb-4 text-gray-600"></i>
                        <p class="text-xl text-gray-400 font-medium">No characters yet.</p>
                        <button onclick="openModal('add-char-modal')" class="mt-4 px-6 py-2 bg-accent-blue hover:bg-accent-blue/90 text-white rounded-full transition-all">Create One</button>
                    </div>
                </div>
            </div>

            <div id="chat-view" class="absolute inset-0 flex flex-col hidden bg-midnight-900 z-20">
                <div class="shrink-0 h-14 border-b border-white/5 flex items-center px-4 bg-midnight-900/50 backdrop-blur-md z-10">
                    <button onclick="switchView('chars-view')" class="mr-4 text-gray-400 hover:text-white"><i class="ph ph-arrow-left text-xl"></i></button>
                    <div class="w-8 h-8 rounded-full bg-midnight-800 mr-3 overflow-hidden"><img id="chat-avatar" src="" class="w-full h-full object-cover"></div>
                    <div>
                        <h3 id="chat-char-name" class="font-bold text-white leading-tight">Character Name</h3>
                        <p class="text-xs text-accent-blue">Roleplay Active</p>
                    </div>
                </div>

                <div id="chat-container" class="flex-1 overflow-y-auto p-4 scroll-smooth" style="overscroll-behavior-y: contain;">
                    <div class="max-w-3xl mx-auto flex flex-col justify-end min-h-full pb-4 space-y-6" id="messages-list"></div>
                    <div id="streaming-placeholder" class="hidden max-w-3xl mx-auto w-full pr-4 md:pr-12 mt-6 flex gap-4">
                        <div class="w-9 h-9 rounded-full bg-midnight-800 flex-shrink-0 overflow-hidden"><img id="stream-avatar" src="" class="w-full h-full object-cover opacity-80 animate-pulse"></div>
                        <div class="prose prose-invert min-w-0 flex-1 msg-content pt-1" id="streaming-content"></div>
                    </div>
                </div>

                <div class="shrink-0 p-4 bg-midnight-900 border-t border-white/5">
                    <div class="max-w-3xl mx-auto relative">
                        <div id="commands-menu" class="hidden absolute bottom-full left-0 mb-2 w-56 bg-midnight-800 border border-white/10 rounded-xl shadow-xl overflow-hidden z-20">
                            <button onclick="openModal('persona-modal'); toggleDropdown('commands-menu')" class="w-full text-left px-4 py-2.5 hover:bg-white/5 flex items-center gap-3 text-sm"><i class="ph ph-user-focus text-accent-blue"></i> Persona</button>
                            <button onclick="triggerImpersonate()" class="w-full text-left px-4 py-2.5 hover:bg-white/5 flex items-center gap-3 text-sm border-t border-white/5"><i class="ph ph-mask-happy text-accent-purple"></i> Impersonate</button>
                        </div>
                        <div class="flex items-end gap-2 bg-midnight-950 border border-white/10 rounded-2xl p-2 shadow-lg focus-within:border-accent-blue/50 transition-all">
                            <button onclick="toggleDropdown('commands-menu')" class="p-3 text-gray-400 hover:text-white transition-colors rounded-xl shrink-0"><i class="ph ph-list-plus text-xl"></i></button>
                            <textarea id="user-input" rows="1" class="w-full bg-transparent border-0 text-white placeholder-gray-500 focus:ring-0 resize-none py-3 max-h-48 msg-content leading-relaxed" placeholder="Type a message..." style="min-height: 48px;"></textarea>
                            <div class="flex items-center gap-1 shrink-0 pb-1">
                                <button onclick="continueChat()" class="p-2 text-gray-400 hover:text-accent-blue hover:bg-white/5 rounded-xl transition-all"><i class="ph ph-arrow-fat-lines-right text-xl"></i></button>
                                <button onclick="sendMessage()" id="send-btn" class="p-2 bg-accent-blue hover:bg-accent-blue/90 text-white rounded-xl shadow-lg transition-all"><i class="ph ph-paper-plane-right text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="add-char-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-midnight-800 w-full max-w-md rounded-2xl border border-white/10 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-white/5 flex justify-between items-center"><h3 class="font-bold text-white text-lg">Create Character</h3><button onclick="closeModal('add-char-modal')" class="text-gray-400 hover:text-white"><i class="ph ph-x text-xl"></i></button></div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Name</label><input type="text" id="new-char-name" class="w-full mt-1 bg-midnight-950 border border-white/10 rounded-xl p-3 text-white outline-none focus:border-accent-blue" placeholder="e.g. Seraphina"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Avatar URL (Image Link)</label><input type="text" id="new-char-avatar" class="w-full mt-1 bg-midnight-950 border border-white/10 rounded-xl p-3 text-white outline-none focus:border-accent-blue" placeholder="https://example.com/image.jpg"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Description / Personality</label><textarea id="new-char-desc" rows="3" class="w-full mt-1 bg-midnight-950 border border-white/10 rounded-xl p-3 text-white text-sm outline-none focus:border-accent-blue" placeholder="Core traits, backstory..."></textarea></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">First Message (Optional)</label><textarea id="new-char-first" rows="3" class="w-full mt-1 bg-midnight-950 border border-white/10 rounded-xl p-3 text-white text-sm outline-none focus:border-accent-blue" placeholder="How they start the chat..."></textarea></div>
            </div>
            <div class="p-5 border-t border-white/5"><button onclick="addNewCharacter()" class="w-full py-3 bg-accent-blue hover:bg-accent-blue/90 text-white font-bold rounded-xl transition-all">Create Character</button></div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-midnight-800 w-full max-w-md rounded-2xl border border-white/10 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-white/5 flex justify-between items-center"><h3 class="font-bold text-white">Settings & API</h3><button onclick="closeModal('settings-modal')" class="text-gray-400 hover:text-white"><i class="ph ph-x text-xl"></i></button></div>
            <div class="p-6 space-y-5 overflow-y-auto">
                <div class="space-y-2"><label class="text-xs font-bold text-gray-500 uppercase">OpenRouter API Key</label><input type="password" id="api-key" class="w-full bg-midnight-950 border border-white/10 rounded-xl p-3 text-white focus:border-accent-blue outline-none"></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-500 uppercase">Model ID</label><input type="text" id="model-id" class="w-full bg-midnight-950 border border-white/10 rounded-xl p-3 text-white focus:border-accent-blue outline-none" placeholder="e.g. undi95/toppy-m-7b:free"></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-500 uppercase">Global System Prompt (Advanced)</label><textarea id="system-prompt" rows="4" class="w-full bg-midnight-950 border border-white/10 rounded-xl p-3 text-white text-sm focus:border-accent-blue outline-none" placeholder="Optional overrides..."></textarea></div>
            </div>
            <div class="p-5 border-t border-white/5"><button onclick="saveSettings()" class="w-full py-3 bg-accent-blue hover:bg-accent-blue/90 text-white font-bold rounded-xl">Save Settings</button></div>
        </div>
    </div>

    <div id="persona-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-midnight-800 w-full max-w-md rounded-2xl border border-white/10 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-white/5 flex justify-between items-center"><h3 class="font-bold text-white">Your Persona</h3><button onclick="closeModal('persona-modal')" class="text-gray-400 hover:text-white"><i class="ph ph-x text-xl"></i></button></div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Your Name</label><input type="text" id="p-name" class="w-full mt-1 bg-midnight-950 border border-white/10 rounded-xl p-3 text-white outline-none focus:border-accent-purple"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Your Details / Appearance</label><textarea id="p-details" rows="4" class="w-full mt-1 bg-midnight-950 border border-white/10 rounded-xl p-3 text-white text-sm outline-none focus:border-accent-purple"></textarea></div>
            </div>
            <div class="p-5 border-t border-white/5"><button onclick="savePersona()" class="w-full py-3 bg-accent-purple hover:bg-accent-purple/90 text-white font-bold rounded-xl">Save Persona</button></div>
        </div>
    </div>

    <script>
        // --- 1. APP STATE ---
        const App = {
            view: 'chars-view',
            characters: [],
            activeCharId: null,
            settings: { apiKey: '', model: 'undi95/toppy-m-7b:free', system: '' },
            persona: { name: 'User', details: '' },
            isGenerating: false,
            
            init() {
                this.loadData();
                initMarkdown();
                this.renderCharsGrid();
                this.updateSettingsUI();
                // Event Listeners for inputs
                document.getElementById('user-input').addEventListener('input', function() { this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 150) + 'px'; });
                document.getElementById('user-input').addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
            },

            loadData() {
                const data = JSON.parse(localStorage.getItem('univ_ai_v7_data') || '{}');
                this.characters = data.characters || [];
                this.settings = data.settings || this.settings;
                this.persona = data.persona || this.persona;
            },
            saveData() {
                localStorage.setItem('univ_ai_v7_data', JSON.stringify({
                    characters: this.characters, settings: this.settings, persona: this.persona
                }));
            },

            // --- VIEW SWITCHING ---
            switchView(viewId) {
                document.getElementById(this.view).classList.add('hidden');
                document.getElementById(viewId).classList.remove('hidden');
                this.view = viewId;
                if (viewId === 'chars-view') {
                    this.activeCharId = null;
                    toggleSidebar(true); // Close sidebar on mobile
                }
            },

            // --- CHARACTER MANAGEMENT ---
            renderCharsGrid() {
                const grid = document.getElementById('chars-grid');
                const emptyMsg = document.getElementById('no-chars-msg');
                grid.innerHTML = '';
                if (this.characters.length === 0) {
                    emptyMsg.classList.remove('hidden'); grid.classList.add('hidden'); return;
                }
                emptyMsg.classList.add('hidden'); grid.classList.remove('hidden');
                
                this.characters.forEach(char => {
                    const card = document.createElement('div');
                    card.className = 'char-card group';
                    // Default avatar if none provided
                    const avatarUrl = char.avatar || 'https://via.placeholder.com/300/1e293b/334155?text=' + char.name.charAt(0);
                    card.innerHTML = `
                        <img src="${avatarUrl}" class="avatar group-hover:scale-105 transition-transform duration-500" onerror="this.src='https://via.placeholder.com/300/1e293b/334155?text=?'">
                        <div class="info">
                            <h3 class="font-bold text-white truncate shadow-sm">${char.name}</h3>
                            <p class="text-xs text-gray-300 truncate opacity-80">${char.description.substring(0, 50)}...</p>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCharacter('${char.id}')" class="absolute top-2 right-2 p-1.5 bg-black/50 text-white opacity-0 group-hover:opacity-100 rounded-full hover:bg-red-600 transition-all z-10"><i class="ph ph-trash"></i></button>
                    `;
                    card.onclick = () => this.openChat(char.id);
                    grid.appendChild(card);
                });
            },

            addNewCharacter() {
                const name = document.getElementById('new-char-name').value.trim();
                if (!name) return alert('Name is required.');
                const newChar = {
                    id: Date.now().toString(),
                    name: name,
                    avatar: document.getElementById('new-char-avatar').value.trim(),
                    description: document.getElementById('new-char-desc').value.trim(),
                    firstMessage: document.getElementById('new-char-first').value.trim(),
                    messages: []
                };
                if (newChar.firstMessage) {
                    newChar.messages.push({ role: 'assistant', content: newChar.firstMessage });
                }
                this.characters.unshift(newChar);
                this.saveData();
                this.renderCharsGrid();
                closeModal('add-char-modal');
                // Clear form
                ['new-char-name','new-char-avatar','new-char-desc','new-char-first'].forEach(id => document.getElementById(id).value = '');
            },

            deleteCharacter(id) {
                if(!confirm('Delete this character and all their chats?')) return;
                this.characters = this.characters.filter(c => c.id !== id);
                this.saveData();
                this.renderCharsGrid();
            },

            // --- CHAT LOGIC ---
            openChat(charId) {
                this.activeCharId = charId;
                const char = this.characters.find(c => c.id === charId);
                if (!char) return;
                
                // Setup Chat UI
                document.getElementById('chat-char-name').textContent = char.name;
                const avatarUrl = char.avatar || 'https://via.placeholder.com/100/1e293b/334155?text=' + char.name.charAt(0);
                document.getElementById('chat-avatar').src = avatarUrl;
                document.getElementById('stream-avatar').src = avatarUrl;
                
                // Render Messages
                const list = document.getElementById('messages-list');
                list.innerHTML = '';
                char.messages.forEach((msg, idx) => this.appendMessage(msg.role, msg.content, idx));
                
                this.switchView('chat-view');
                this.scrollToBottom();
            },

            appendMessage(role, text, index) {
                const list = document.getElementById('messages-list');
                const isUser = role === 'user';
                const bubble = document.createElement('div');
                bubble.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} group relative animate-in fade-in duration-300`;
                
                const contentHtml = DOMPurify.sanitize(marked.parse(text));
                
                if (isUser) {
                    bubble.innerHTML = `
                        <div class="max-w-[85%] md:max-w-[75%] relative">
                            <button onclick="editMessage(${index})" class="absolute -left-8 top-1/2 -translate-y-1/2 p-1.5 text-gray-500 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph ph-pencil-simple"></i></button>
                            <div class="msg-user px-5 py-3.5 text-sm md:text-base prose prose-invert msg-content">${contentHtml}</div>
                        </div>`;
                } else {
                    const char = this.characters.find(c => c.id === this.activeCharId);
                    const avatarUrl = char?.avatar || 'https://via.placeholder.com/100/1e293b/334155?text=AI';
                    bubble.innerHTML = `
                        <div class="max-w-3xl flex gap-4 pr-4 md:pr-12">
                            <div class="w-9 h-9 rounded-full flex-shrink-0 overflow-hidden bg-midnight-800 mt-1"><img src="${avatarUrl}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/100/1e293b/334155?text=AI'"></div>
                            <div class="msg-ai p-5 text-sm md:text-base prose prose-invert min-w-0 flex-1 msg-content shadow-md">${contentHtml}</div>
                        </div>`;
                }
                list.appendChild(bubble);
                bubble.querySelectorAll('pre code').forEach(b => highlight.highlightElement(b));
            },

            async sendMessage(isContinue = false) {
                const inputBtn = document.getElementById('send-btn');
                const inputField = document.getElementById('user-input');
                const text = inputField.value.trim();

                if (!this.activeCharId || this.isGenerating || (!isContinue && !text)) return;
                if (!this.settings.apiKey) return alert('Please set your API Key in Settings.');

                const char = this.characters.find(c => c.id === this.activeCharId);
                
                // Add User Message
                if (!isContinue) {
                    char.messages.push({ role: 'user', content: text });
                    this.appendMessage('user', text, char.messages.length - 1);
                    inputField.value = ''; inputField.style.height = 'auto';
                }

                this.saveData(); this.scrollToBottom();

                // Prep UI for Stream
                this.isGenerating = true;
                inputBtn.disabled = true; inputBtn.classList.add('opacity-50');
                const streamBox = document.getElementById('streaming-placeholder');
                const streamContent = document.getElementById('streaming-content');
                streamBox.classList.remove('hidden');
                streamContent.innerHTML = '<span class="cursor-blink"></span>';
                this.scrollToBottom();

                let fullResponse = "";

                try {
                    // Build Prompt
                    const history = char.messages.slice(-15); // Context limit
                    let systemPrompt = this.settings.system || "You are a creative roleplay AI.";
                    // Inject Character Data & Persona
                    systemPrompt += `\n\n[CHARACTER CARD]\nName: ${char.name}\nDescription: ${char.description}\n\n[USER PERSONA]\nName: ${this.persona.name}\nDetails: ${this.persona.details}\n\n[INSTRUCTION] Stay in character as ${char.name}. Respond directly to ${this.persona.name}.`;

                    const messages = [{ role: 'system', content: systemPrompt }, ...history];
                    const cleanKey = this.settings.apiKey.replace(/[^\x20-\x7E]/g, '').trim();
                    const cleanModel = this.settings.model.trim();

                    const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${cleanKey}`, "Content-Type": "application/json", "HTTP-Referer": "https://github.com/universal-ai-v7", "X-Title": "Universal AI V7" },
                        body: JSON.stringify({ model: cleanModel, messages: messages, stream: true, max_tokens: 4096 })
                    });

                    if (!resp.ok) throw new Error(`API Error ${resp.status}`);

                    const reader = resp.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        chunk.split('\n').forEach(line => {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const delta = JSON.parse(line.slice(6)).choices[0]?.delta?.content || "";
                                    fullResponse += delta;
                                    streamContent.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                                    this.smartScroll();
                                } catch (e) {}
                            }
                        });
                    }
                } catch (e) {
                    fullResponse += `\n\n*Error: ${e.message}*`;
                    streamContent.innerHTML = marked.parse(fullResponse);
                } finally {
                    this.isGenerating = false;
                    inputBtn.disabled = false; inputBtn.classList.remove('opacity-50');
                    streamBox.classList.add('hidden');
                    char.messages.push({ role: 'assistant', content: fullResponse });
                    this.appendMessage('assistant', fullResponse);
                    this.saveData(); this.scrollToBottom();
                }
            },

            // --- UTILS ---
            scrollToBottom() { const c = document.getElementById('chat-container'); c.scrollTop = c.scrollHeight; },
            smartScroll() { const c = document.getElementById('chat-container'); if (c.scrollHeight - c.scrollTop - c.clientHeight < 150) c.scrollTop = c.scrollHeight; },
            updateSettingsUI() {
                document.getElementById('api-key').value = this.settings.apiKey;
                document.getElementById('model-id').value = this.settings.model;
                document.getElementById('system-prompt').value = this.settings.system;
                document.getElementById('p-name').value = this.persona.name;
                document.getElementById('p-details').value = this.persona.details;
            },
            saveSettings() {
                this.settings.apiKey = document.getElementById('api-key').value;
                this.settings.model = document.getElementById('model-id').value;
                this.settings.system = document.getElementById('system-prompt').value;
                this.saveData(); closeModal('settings-modal');
            },
            savePersona() {
                this.persona.name = document.getElementById('p-name').value || 'User';
                this.persona.details = document.getElementById('p-details').value;
                this.saveData(); closeModal('persona-modal');
            }
        };

        // --- GLOBAL HELPERS (for HTML onclicks) ---
        window.toggleSidebar = (forceClose) => {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay');
            if (forceClose || !sb.classList.contains('-translate-x-full')) { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); } else { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
        };
        window.toggleDropdown = (id) => { document.getElementById(id).classList.toggle('hidden'); };
        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); if(id==='settings-modal' || id==='persona-modal') App.updateSettingsUI(); };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.switchView = (id) => App.switchView(id);
        window.addNewCharacter = () => App.addNewCharacter();
        window.deleteCharacter = (id) => App.deleteCharacter(id);
        window.sendMessage = () => App.sendMessage();
        window.continueChat = () => App.sendMessage(true);
        window.saveSettings = () => App.saveSettings();
        window.savePersona = () => App.savePersona();
        window.editMessage = (idx) => {
            const char = App.characters.find(c => c.id === App.activeCharId);
            if (!confirm('Edit message? Subsequent messages will be lost.')) return;
            document.getElementById('user-input').value = char.messages[idx].content;
            char.messages = char.messages.slice(0, idx);
            App.saveData(); App.openChat(char.id);
        };
        window.triggerImpersonate = async () => {
            toggleDropdown('commands-menu'); const input = document.getElementById('user-input');
            input.placeholder = "Generating..."; input.disabled = true;
            const char = App.characters.find(c => c.id === App.activeCharId);
            const hist = char.messages.slice(-10);
            hist.push({role:'system', content: `[SYSTEM: Write the next response for user "${App.persona.name}". Output text only.]`});
            try {
                const cleanKey = App.settings.apiKey.replace(/[^\x20-\x7E]/g, '').trim();
                const r = await fetch("https://openrouter.ai/api/v1/chat/completions", { method:"POST", headers:{"Authorization":`Bearer ${cleanKey}`,"Content-Type":"application/json"}, body:JSON.stringify({model:App.settings.model, messages:hist})});
                const d = await r.json(); input.value = d.choices[0].message.content;
            } catch(e) { alert('Error: '+e.message); }
            input.disabled=false; input.placeholder="Type a message..."; input.focus();
        };

        // --- BOOT ---
        App.init();
        function initMarkdown() { marked.use({ gfm: true, breaks: true, highlight: (code, lang) => hljs.highlightAuto(code).value }); }
    </script>
</body>
</html>
